#Блок управления нагрузками

Блок управления нагрузками предназначен
для работы в качестве промежуточного устройства
для подачи и управления нагрузками через
текстовый или web-интерфейсы.

Устройство также предназначено для управления
силовыми электроприборами и может использоваться
в быту.

Этот репозиторий соедржит материалы,
относящиеся к блоку управления нагрузками.

Устройство состоит из:
````
  Raspberry Pi B+;
  SD карта (минимум 8гб);
  8 канальный релейный модуль;
  Дисплей (20 на 4 символов);
  2 розетка (220 В);
  Модуль реального времени (Tiny RTC);
  USB-Ethernt переходник;
  Wi-Fi донгл;
  Соединительные провода.
````
##Нижме описан порядок настройки Raspberry Pi (rpi)
Вставляем SD карту в ПК.
Скачиваем с [официального сайта](https://www.raspberrypi.org/downloads/)
````
  Raspbian
````
Если ОС вашего ПК - Linux:
Проверяем подключение SD карты к ПК с помощью команды:
````
  dmesg
````
Необходимо найти строку с указанием SD карты
и путь к ней.
У каждого он будет свой:
````
  /dev/sd?
````
Установить скаченный *.img файл Raspbian на SD карту
можно с помощью команды:
````
  dd bs=4M if=*-raspbian-wheezy.img of=/dev/sd?
````
где /deb/sd? - путь к SD карте. (например /dev/sdb)

Возможно произвести частичные настройки rpi
сразу после установки ОС на SD карту.
Для этого необходимо смонтировать раздел SD карты командой:
````
  mount /dev/sdb2 /mnt
````
После этого можно перейти в папку /mnt на ПК
и произвести настройку rpi
(например сетевых интерфейсов если rpi будет иметь
статический ip адрес).
По окончанию настройки необходимо выполнить команду:
````
  umount /dev/sdb2
````
Подготовленную для работы SD карту
необходимо установить в rpi.
Если rpi не имеет статического адреса
и нет возможности узнать полученный адрес по dhcp,
то необходимо подключиться к rpi по UART.

Если ПК имеет ОС Windows то возможно использоваться
программу Putty.
Подлкючив rpi по UART.
Узнать номер COM порта присвоенный rpi.
В Putty выбрать Serial.
В строку ввести номер COM порта.
Установить скорость 115200 и создать подключение.
Если все настроено правильно, вы увидите поле для ввода
логина и пароля.

Если ПК имеет ОС Linux то можно воспользоваться minicom.
Подключив rpi по UART.
Необходимо зайти под root пользователем командой
````
  su
````
Настроить minicom командой:
````
  minicom -s USB0
````
возможно будет другой номер USB.
Номер порта USB можно посмотреть командой:
````
  lsusb
````
В открывшемся окне необходимо настроить параметры:
````
  Serial Device : /dev/ttyUSB0
  Bps/Par/Bits : 115200
  Hardware Flow Control : No
  Software Flow Control : No
````
Для сохранения выберите
````
  Save setup as USB0
````
Для выхода нажмите
````
  Exit
````
После этого, появится в терминале поле для ввода логина и пароля
````
  Логин: pi
  Пароль: raspberry
````
Далее необходимо настроить ip адресс rpi или
узнать присвоенный адрес.
Для проверки состояний сетевых интерфейсов выполните:
````
  ifconfig eth0
````
Если rpi не имеет ip адреса то необходимо открыть файл настройки
сетевых интерфейсов с помощью команды:
````
  vi /etc/network/interfaces
````
Добавить или заменить:
если статический ip адрес
````
auto eth0
allow-hotplug eth0
iface eth0 inet static
        address 192.168.1.2
        netmask 255.255.255.0
        network 192.168.1.0
        broadcast 192.168.1.255
````
если получать ip по dhcp
````
  auto eth0
  allow-hotplug eth0
  iface eth0 inet dhcp
````
Для настроек ssh, I2C, SPI выполните:
````
  raspi-config
````
Для расширении памяти на всю SD карту необходимо выбрать:
````
  Expand Filesystem
````
Для настроек опций необходимо выбрать:
````
  Advanced Options
````
И выбрать 
````
  SSH -> Enabled
  SPI -> Enabled
  I2C -> Enabled
````
При выходе из меню настроек, необходимо
согласитсья на "reboot" (перезагрузку rpi).

Для удобства подключения и переноса файлов на rpi
сгенерируйте ключ ssh-keygen
скопируйте файл .ssh/id_rsa.pub со своего ПК
на rpi в файл .ssh/authorized_keys
с помощью команд:
````
  ssh-keygen
  cd .ssh
  ssh-copy-id -i id_rsa.pub pi@192.168.1.2:
  pi@192.168.1.2 password: raspberry

  scp id_rsa.pub pi@192.168.1.2:
  ssh pi@192.168.1.2
  sudo bash
  cat /home/pi/id_rsa.pub >> /root/.ssh/authorized_keys
````
Добавьте в файл на своем ПК .ssh/config:
````
  Host rpi
    HostName 192.168.1.2
    User root
````
где 192.168.1.2 ip адрес rpi
После чего можно подключаться к rpi командой:
````
  ssh rpi
````
В случае необходимости, для покдлючения rpi
к сети интернет необходимо выполнить тунель
с помощью команды в терминале на ПК:
````
  ssh localhost -N -L ip_адрес_ПК:порт:прокси:порт
````
на rpi выполнить:
````
  export http_proxy=http://ip_адрес_ПК:порт
````
Дальнейшая интрукция выполняется из под root пользователя
Зайти под root пользователем можно командой:
````
  sudo bash
````
При получении доступа в интернет на rpi
необходимо установить пакеты с помощью apt-get install:
````
  vim
  i2c-tools
  php5
  apache2
  python
  ajaxterm
  motion
````
Для работы некоторых команд выполняющихся по веб интерфейсу
необходимо ввести:
````
  visudo
````
И в конце добавить строку:
````
  www-data ALL=(ALL) NOPASSWD: ALL
````
Склонируйте репозиторий на ПК или сразу на rpi
Это можно сделать командой:
````
  git clone https://github.com/alllecs/raspberry_relay.git
````
Из папки raspberry_relay необходимо перенести файлы:
(Если в /var/www/ присутствуюет папка html,
то файлы переносятся в /var/www/html/)
````
  cp txt/menu.sh /usr/local/bin/
  cp bin/relay.sh /var/www/
  cp web/* /var/www/
````
Также необходимо удалить стандартный файл html
с помощью команды:
````
  rm /var/www/index.html
````
Текстовый и web-интерфейсы настроены.
Для проверки можно запустить текстовый интерфейс
с помощью команды:
````
  menu.sh
````
Для проверки web-интерфейса с ПК при необходимости
надо выполнить команду
````
  ssh 'сервер' -L 8080:rpi:80
````
где сервер - сервер ЛС куда подключен rpi.
В браузере укажите ip-адрес rpi если rpi подключен
напрямую к ПК.
Или укажите:
````
  localhost:8080
````
если rpi подключен в ЛС.

##Инструкция для настройки дисплея (20х4 символов)
Подключитесь к rpi.
Перейдите в файл /etc/modules c помощью команды:
````
  sudo nano /etc/modules
````
Добавьте 2 строки:
````
  i2c-bcm2708
  i2c-dev
````
Перейдите в файл командой
````
  sudo nano /etc/modprobe.d/raspi-blacklist.conf
```
Закомментируйте эту строку
````
  #blacklist i2c-bcm2708
```
Если пакеты не установлены,
то для установки выполните:
````
  sudo apt-get install python-smbus i2c-tools
  sudo apt-get install python-dev python-rpi.gpio
````
Для применения изменений перезапустите rpi
````
  sudo reboot
````
Проверить список подключенных устройств
можно командой:
````
  sudo i2cdetect -y 1
````
Дисплей должен иметь адрес #27
Для обновления дисплея каждую минуту
необходимо выполнить:
````
  crontab -e
````
Добавить в конец файла:
````
  * * * * * /home/pi/raspberry_relay/i2c/file.py
````
Перейдите в папку /home/pi/raspberry_relay/i2c/
с помощью команды:
````
  cd /home/pi/raspberry_relay/i2c/
````
Необходимо выполнять скрипт startpin.sh при запуске rpi
для экспорта необходимых gpio.
Для этого:
````
  chmod +x startpin.sh
  sudo cp startpin.sh /etc/init.d/
  update-rc.d startpin.sh defaults
````
Подключите дисплей по I2C.
После чего перезапустите rpi
````
  sudo reboot
````
Если все настроено правильно, на дисплей будет выведено
время, состояния реле, ip адрес rpi.

##Настройка dhcp сервера на rpi

Необходимо установить пакет, выполнив:
````
  apt-get install isc-dhcp-server
````
Для выбора интерфеса для dhcp сервера,
необходимо перейти в файл
````
  sudo vim /etc/default/isc-dhcp-server
````
Добавить необходимый интерфейс:
````
  INTERFACES="eth1"
````
Для настройки dhcp необходимо перейти
в файл или создать его:
````
  vim /etc/dhcp/dhcpd.conf
````
Содержание файла:
````
 authoritative;
 default-lease-time 600;
 max-lease-time 7200;
 #log-facility local7;

 subnet 10.223.254.0 netmask 255.255.255.0
 {
	option subnet-mask 255.255.255.0;
	option routers 10.223.254.1;
	option broadcast-address 10.223.254.255;
	option domain-name-servers 10.223.254.3, 8.8.8.8;
	option domain-name "linux-asus-i386";
	range 10.223.254.2 10.223.254.199;
 }
````
Перезапуск dhcp-сервера с помощью команды:
````
  service isc-dhcp-server restart
````
Если все сделано правильно, то при перезапуске
не будет ошибки.
